name: ERDKK versi Web Otomatis

on:
  schedule:
    # Jam 22:00 UTC = 05:00 WIB (setiap hari)
    - cron: "0 22 1 * *"
  workflow_dispatch:  # Manual trigger
  push:
    branches: [ main, master ]
    paths:
      - 'scripts/erdkk_versi_web.py'
      - '.github/workflows/rekap-erdkk.yml'

jobs:
  run-erdkk-processor:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Tambah timeout karena proses banyak file

    steps:
      - name: ðŸ›Žï¸ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ Setup Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: 'pip'

      - name: ðŸ“¦ Install dependencies
        run: |
          pip install --upgrade pip
          pip install pandas>=2.0.0
          pip install gspread>=5.0.0
          pip install google-auth>=2.0.0
          pip install google-api-python-client>=2.0.0
          pip install openpyxl>=3.0.0
          pip install PyYAML>=6.0
          pip install gspread-dataframe>=3.3.0
          pip install python-dotenv>=1.0.0
          pip install chardet>=5.0.0

      - name: ðŸ”§ Set environment variables
        run: |
          echo "PYTHONPATH=${{ github.workspace }}" >> $GITHUB_ENV
          echo "TZ=Asia/Jakarta" >> $GITHUB_ENV

      - name: ðŸ“‚ Create directories
        run: |
          mkdir -p scripts
          mkdir -p logs
          mkdir -p temp

      - name: ðŸš€ Run ERDKK Processor Script
        env:
          GOOGLE_APPLICATION_CREDENTIALS_JSON: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON }}
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          SENDER_EMAIL_PASSWORD: ${{ secrets.SENDER_EMAIL_PASSWORD }}
          RECIPIENT_EMAILS: ${{ secrets.RECIPIENT_EMAILS }}
        run: |
          echo "ðŸŽ¯ Memulai proses rekap data ERDKK..."
          echo "ðŸ“… Waktu: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "ðŸ“ Folder ID: 13N5dLdHzAKff6g8RDRiHa7LFyZbdJUCJ"
          echo "ðŸ“Š Spreadsheet ID: 1aEx7cgw1KIdpXo20dD3LnCHF6PWer1wWgT7H5YKSqlY"
          echo "ðŸ“§ Email pengirim: $SENDER_EMAIL"
          echo "ðŸ“§ Email penerima: $RECIPIENT_EMAILS"
          echo ""
          
          # Cek apakah file script ada
          if [ -f "scripts/erdkk_versi_web.py" ]; then
            echo "âœ… Script ditemukan: scripts/erdkk_versi_web.py"
          else
            echo "âŒ Script tidak ditemukan! Pastikan file erdkk_versi_web.py ada di folder scripts/"
            exit 1
          fi
          
          # Jalankan script Python
          echo "â–¶ï¸  Menjalankan script ERDKK..."
          cd scripts
          python erdkk_versi_web.py
          
          EXIT_CODE=$?
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ… Script berhasil dijalankan dengan exit code: $EXIT_CODE"
          else
            echo "âŒ Script gagal dengan exit code: $EXIT_CODE"
            # Simpan log error
            echo "ðŸ’¾ Menyimpan log error..."
            echo "Exit Code: $EXIT_CODE" > ../logs/error_$(date +%Y%m%d_%H%M%S).log
            echo "Time: $(date)" >> ../logs/error_$(date +%Y%m%d_%H%M%S).log
          fi
          
          cd ..
          
          echo ""
          echo "ðŸ Proses selesai pada: $(date '+%Y-%m-%d %H:%M:%S %Z')"

      - name: ðŸ“¤ Upload processed data (if exists)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: erdkk-processed-data
          path: |
            data_erdkk/
            logs/
          retention-days: 3

      - name: ðŸ“‹ Upload error logs (if failed)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: erdkk-error-logs
          path: |
            logs/
            data_erdkk/
            temp/
          retention-days: 7

      - name: ðŸ§¹ Clean up temporary files
        if: always()
        run: |
          echo "ðŸ§¹ Membersihkan file temporary..."
          rm -rf data_erdkk/ 2>/dev/null || true
          rm -rf temp/ 2>/dev/null || true
          echo "âœ… Clean up selesai"

      - name: ðŸ“Š Generate workflow summary
        if: always()
        run: |
          echo "## ðŸ“‹ Ringkasan Proses Rekap ERDKK versi WEB" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Waktu Eksekusi:**" >> $GITHUB_STEP_SUMMARY
          echo "- Dimulai: ${{ fromJSON('{}').startedAt || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Selesai: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          
          if github.event_name == 'schedule' ]; then
            echo "- Schedule: 16:00 UTC (23:00 WIB) setiap hari" >> $GITHUB_STEP_SUMMARY
          elif github.event_name == 'workflow_dispatch' ]; then
            echo "- Manual trigger oleh: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Links:**" >> $GITHUB_STEP_SUMMARY
          echo "- [Spreadsheet Hasil](https://docs.google.com/spreadsheets/d/1aEx7cgw1KIdpXo20dD3LnCHF6PWer1wWgT7H5YKSqlY/edit)" >> $GITHUB_STEP_SUMMARY
          echo "- [Folder Data ERDKK](https://drive.google.com/drive/folders/13N5dLdHzAKff6g8RDRiHa7LFyZbdJUCJ)" >> $GITHUB_STEP_SUMMARY
